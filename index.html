<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cup Mapper — Smart Mixing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <!-- Flat paths since all files are in the root -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- ===================== Top Bar ===================== -->
  <header class="topbar" role="banner">
    <div class="topbar__left">
      <h1 class="app-title">Cup Mapper</h1>
      <span class="app-subtitle">Limited inks · Auto Smart Mix · Pattern Replace</span>
    </div>
    <nav class="topbar__right" aria-label="App actions">
      <button id="btnOpenHelp" class="btn btn-ghost" title="Help">Help</button>
      <button id="btnOpenAbout" class="btn btn-ghost" title="About">About</button>
      <button id="openProjects" class="btn btn-primary" title="Projects">Projects</button>
    </nav>
  </header>

  <!-- ===================== Layout ===================== -->
  <main class="layout">
    <!-- ========== LEFT: Controls ========== -->
    <aside class="panel panel--controls" aria-label="Controls">
      <!-- Upload & Preview Controls -->
      <section class="card" aria-labelledby="sec-upload-h">
        <div class="card__header">
          <h2 id="sec-upload-h">1) Upload & Preview</h2>
          <p class="muted">AI image, selfie, logo — EXIF rotation handled.</p>
        </div>
        <div class="card__body">
          <div class="heroWrap" style="margin-bottom:10px">
            <canvas id="heroCanvas" width="0" height="0" aria-label="Original image preview"></canvas>
          </div>

          <div class="row wrap uploader">
            <input id="fileInput" type="file" accept="image/*" aria-label="Choose image" />
          </div>

          <div class="uploader__row">
            <label>Max width
              <input id="maxW" type="number" min="256" max="4096" value="1600" />
            </label>
            <div class="preview-zoom">
              <label>Zoom</label>
              <input id="zoom" type="range" min="10" max="400" value="100" />
              <span id="zoomLabel" class="mono">100%</span>
            </div>
            <button id="btnZoomFit" class="btn btn-ghost">Fit</button>
            <button id="btnZoom100" class="btn btn-ghost">100%</button>
          </div>

          <div class="row wrap" style="margin-top:10px;">
            <button id="btnLoadSample" class="btn">Load sample</button>
            <button id="btnClear" class="btn btn-danger">Clear</button>
          </div>
        </div>
      </section>

      <!-- Original Palette -->
      <section class="card" aria-labelledby="sec-origpal-h">
        <div class="card__header">
          <h2 id="sec-origpal-h">2) Original palette</h2>
          <p class="muted">Extract dominant colors or add with eyedropper.</p>
        </div>
        <div class="card__body">
          <div class="row wrap">
            <label>Clusters
              <input id="kClusters" type="range" min="2" max="16" value="8" />
              <span id="kClustersOut" class="mono">8</span>
            </label>
            <button id="btnExtract" class="btn">Extract</button>
            <button id="btnEyedropper" class="btn btn-ghost" title="Pick a color from image">Eyedropper</button>
          </div>
          <div id="origPalette" class="swatch-grid" aria-live="polite" aria-label="Original palette swatches"></div>
        </div>
      </section>

      <!-- Restricted Palette (Inks) -->
      <section class="card" aria-labelledby="sec-restr-h">
        <div class="card__header">
          <h2 id="sec-restr-h">3) Restricted palette (inks)</h2>
          <p class="muted">Choose up to 10 inks. Save as kits.</p>
        </div>
        <div class="card__body">
          <div class="row wrap">
            <button id="btnFromOriginal" class="btn">From original</button>
            <label class="switch" title="Allow White">
              <input id="allowWhite" type="checkbox" />
              <span></span>
            </label>
            <span class="muted">Allow White</span>
            <button id="btnAddInk" class="btn btn-ghost">Add ink</button>
          </div>

          <div id="restrictedList" class="restricted-list" aria-live="polite"></div>

          <div class="divider"></div>
          <div class="row wrap">
            <label>Save kit as
              <input id="kitName" type="text" placeholder="My 5-ink kit" />
            </label>
            <button id="btnSaveKit" class="btn">Save kit</button>
            <button id="btnLoadKit" class="btn btn-ghost">Load kit</button>
            <button id="btnDeleteKit" class="btn btn-danger">Delete kit</button>
          </div>
        </div>
      </section>

      <!-- Smart Mixing -->
      <section class="card" aria-labelledby="sec-mix-h">
        <div class="card__header">
          <h2 id="sec-mix-h">4) Smart Mixing</h2>
          <p class="muted">Auto mix missing colors or override per-color using Pattern mode.</p>
        </div>
        <div class="card__body">
          <div class="row wrap">
            <label class="switch">
              <input id="autoSmart" type="checkbox" checked />
              <span></span>
            </label>
            <span class="muted">Auto mix missing colors</span>

            <label>Max inks / mix
              <select id="maxInksPerMix">
                <option value="2" selected>2</option>
                <option value="3">3</option>
              </select>
            </label>

            <label>Gamut sensitivity
              <input id="gamutSensitivity" type="range" min="0" max="100" value="60" />
              <span id="gamutSensitivityOut" class="mono">60</span>
            </label>
          </div>

          <div class="row wrap">
            <label>Block (cells)
              <input id="mixBlock" type="number" min="3" max="16" value="6" />
            </label>
            <label>Cell (px)
              <input id="mixCell" type="number" min="1" max="16" value="3" />
            </label>
            <label>Pattern order
              <select id="mixPattern">
                <option value="bluenoise" selected>Blue-noise</option>
                <option value="bayer">Bayer</option>
                <option value="checker">Checker</option>
                <option value="stripeH">Stripes (H)</option>
                <option value="stripeV">Stripes (V)</option>
              </select>
            </label>
            <button id="btnGenerateMixes" class="btn">Generate mixes</button>
          </div>

          <!-- Rules table -->
          <div class="divider"></div>
          <div class="rules">
            <table id="rulesTable" class="table" aria-label="Mix and Pattern rules per original color">
              <thead>
                <tr>
                  <th>On</th>
                  <th>Original</th>
                  <th>Mode</th>
                  <th>Preview</th>
                  <th>Params</th>
                  <th>ΔE</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Template for a rule row -->
          <template id="tplRule">
            <tr>
              <td>
                <label class="switch"><input type="checkbox" data-fn="toggleOn" /><span></span></label>
              </td>
              <td>
                <div class="swatch swatch--orig" data-ref="origSwatch" title="Original color" style="grid-template-columns:1fr;"></div>
              </td>
              <td>
                <select data-ref="mode">
                  <option value="mix">Mix</option>
                  <option value="pattern">Pattern</option>
                </select>
              </td>
              <td>
                <canvas width="64" height="64" data-ref="preview"></canvas>
              </td>
              <td>
                <!-- MIX MODE params -->
                <div class="mix-grid" data-ref="mixParams">
                  <label>Inks
                    <div class="ink-pills" data-ref="mixInks"></div>
                  </label>
                  <label>Weights
                    <div class="weights" data-ref="mixWeights"></div>
                  </label>
                  <div class="row wrap">
                    <label>Block
                      <input type="number" min="3" max="16" value="6" data-ref="mixBlock" />
                    </label>
                    <label>Cell
                      <input type="number" min="1" max="16" value="3" data-ref="mixCell" />
                    </label>
                    <label>Pattern
                      <select data-ref="mixPattern">
                        <option value="bluenoise">Blue-noise</option>
                        <option value="bayer">Bayer</option>
                        <option value="checker">Checker</option>
                        <option value="stripeH">Stripes (H)</option>
                        <option value="stripeV">Stripes (V)</option>
                      </select>
                    </label>
                  </div>
                </div>

                <!-- PATTERN MODE params -->
                <div class="mix-grid hidden" data-ref="patternParams">
                  <div class="row wrap">
                    <label>Shape
                      <select data-ref="shape">
                        <option value="dot">Dot</option>
                        <option value="square">Square</option>
                        <option value="triangle">Triangle</option>
                        <option value="diamond">Diamond</option>
                        <option value="cross">Cross</option>
                        <option value="stripeH">Stripe H</option>
                        <option value="stripeV">Stripe V</option>
                        <option value="checker">Checker</option>
                      </select>
                    </label>
                    <label>BG
                      <input type="text" data-ref="bgHex" placeholder="#FFFFFF" class="mono" />
                    </label>
                    <label>Ink(s)
                      <div class="ink-pills" data-ref="shapeInks"></div>
                    </label>
                  </div>
                  <div class="row wrap">
                    <label>Cell
                      <input type="number" min="1" max="16" value="3" data-ref="patCell" />
                    </label>
                    <label>Size
                      <input type="range" min="10" max="100" value="65" data-ref="shapeSize" />
                      <span data-ref="shapeSizeOut" class="mono">65%</span>
                    </label>
                    <label class="switch" title="Stagger rows">
                      <input type="checkbox" data-ref="stagger" />
                      <span></span>
                    </label>
                    <span class="muted">Stagger</span>
                    <label>Block
                      <input type="number" min="3" max="16" value="6" data-ref="patBlock" />
                    </label>
                  </div>
                </div>
              </td>
              <td><span class="mono" data-ref="errOut">—</span></td>
              <td><button class="btn btn-ghost" data-fn="reset">Reset</button></td>
            </tr>
          </template>
        </div>
      </section>

      <!-- Map to Palette -->
      <section class="card" aria-labelledby="sec-map-h">
        <div class="card__header">
          <h2 id="sec-map-h">5) Map to palette</h2>
        </div>
        <div class="card__body">
          <div class="row wrap">
            <label>ΔL weight
              <input id="wLight" type="range" min="0" max="200" value="100" />
              <span id="wLightOut" class="mono">1.00</span>
            </label>
            <label>ΔC weight
              <input id="wChroma" type="range" min="0" max="200" value="100" />
              <span id="wChromaOut" class="mono">1.00</span>
            </label>
            <label class="switch"><input id="useDither" type="checkbox" /><span></span></label>
            <span class="muted">Dither (Floyd–Steinberg)</span>
            <label class="switch"><input id="useSharpen" type="checkbox" /><span></span></label>
            <span class="muted">Sharpen</span>
            <label>BG mode
              <select id="bgMode">
                <option value="keep" selected>Keep</option>
                <option value="white">White</option>
                <option value="transparent">Transparent</option>
              </select>
            </label>
            <label>Preview scale
              <select id="previewScale">
                <option value="1">100%</option>
                <option value="0.75">75%</option>
                <option value="0.5">50%</option>
                <option value="0.25">25%</option>
              </select>
            </label>
          </div>

          <div class="row wrap" style="margin-top:8px">
            <button id="applyBtn" class="btn btn-primary">Apply</button>
            <button id="bigRegen" class="btn btn-ghost">Regenerate</button>
            <div id="mapProgress" class="progress hidden" role="status" aria-live="polite">
              <span class="spinner" aria-hidden="true"></span>
              <span id="mapProgressLabel">Mapping…</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Export -->
      <section class="card" aria-labelledby="sec-export-h">
        <div class="card__header">
          <h2 id="sec-export-h">6) Export</h2>
        </div>
        <div class="card__body">
          <div class="row wrap" style="align-items:flex-end; gap:12px;">
            <label>PNG scale
              <input id="exportScale" type="number" min="1" max="16" value="4" />
            </label>
            <label class="switch"><input id="exportTransparent" type="checkbox" /><span></span></label>
            <span class="muted">Transparent background</span>
            <button id="btnExportPNG" class="btn btn-primary">Export PNG</button>
            <button id="btnExportSVG" class="btn btn-ghost">Export SVG</button>
            <button id="btnExportReport" class="btn btn-ghost">Export Report</button>
          </div>
        </div>
      </section>
    </aside>

    <!-- ========== RIGHT: Preview Canvases ========== -->
    <section class="panel panel--preview" aria-label="Preview">
      <figure class="heroWrap">
        <figcaption class="figcaption">Original (hero preview)</figcaption>
        <div class="canvas-scroll">
          <canvas id="heroCanvas" aria-label="Hero preview"></canvas>
        </div>
      </figure>

      <div class="canvas-stack">
        <figure class="canvas-wrap">
          <figcaption class="figcaption">Mapped Image</figcaption>
          <div class="canvas-scroll">
            <canvas id="mappedCanvas" aria-label="Mapped image"></canvas>
          </div>
        </figure>
      </div>
    </section>
  </main>

  <!-- ===================== Projects Drawer ===================== -->
  <aside id="projectsPane" class="drawer hidden" aria-labelledby="projectsTitle" aria-hidden="true">
    <div class="drawer__head">
      <h2 id="projectsTitle">Projects</h2>
      <button id="closeProjects" class="btn btn-ghost">Close</button>
    </div>
    <div class="drawer__body">
      <div class="row wrap">
        <button id="refreshProjects" class="btn btn-ghost">Refresh</button>
        <button id="saveProject" class="btn">Save current</button>
        <button id="exportProject" class="btn btn-ghost">Export JSON</button>
        <label class="filelike btn btn-ghost">Import JSON
          <input id="importProject" type="file" accept="application/json" />
        </label>
        <button id="deleteProject" class="btn btn-danger">Delete selected</button>
      </div>
      <ul id="projectsList" class="list"></ul>
    </div>
  </aside>

  <!-- ===================== Dialogs ===================== -->
  <dialog id="dlgHelp" class="modal">
    <div class="modal__header">
      <h3>Help</h3>
      <button id="btnCloseHelp" class="btn btn-ghost">Close</button>
    </div>
    <div class="modal__body">
      <ol class="help-steps">
        <li>Upload an image. Adjust zoom and max preview width.</li>
        <li>Extract the <strong>Original Palette</strong> or add colors via the eyedropper.</li>
        <li>Build your <strong>Restricted Palette</strong>. Save your kit if you like.</li>
        <li>Enable <strong>Auto Smart Mix</strong> to approximate missing colors. Tweak per-color rules (Mix or Pattern).</li>
        <li>Click <strong>Apply</strong> to map. Regenerate mixes after big palette changes.</li>
        <li>Export PNG/SVG, or create a printer report.</li>
      </ol>
    </div>
  </dialog>

  <dialog id="dlgAbout" class="modal">
    <div class="modal__header">
      <h3>About</h3>
      <button id="btnCloseAbout" class="btn btn-ghost">Close</button>
    </div>
    <div class="modal__body">
      <p><strong>Cup Mapper</strong> — limited inks remapper with automated Smart Mixing and per-color Pattern Replace.</p>
      <p>Exports: PNG (1×–16×), SVG (rect-per-pixel), and printer-friendly report.</p>
    </div>
  </dialog>

  <!-- ===================== Toasts ===================== -->
  <div id="toasts" class="toast-host" aria-live="polite" aria-atomic="true"></div>

  <!-- ===================== Script ===================== -->
  <script type="module" src="app.js"></script>
</body>
</html>
